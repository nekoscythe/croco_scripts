#!/bin/bash

# --- Defaults ---
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
CONFIG_FILE="$SCRIPT_DIR/Configs/config_map.yaml"
TEST_DIR="test"
FORCE=false      # Default: don't overwrite

# Check if metadata.yaml exists and extract test_id
if [[ -f metadata.yaml ]]; then
  TEST_ID=$(yq e ".test_id" metadata.yaml)
  TEST_NAME=$(yq e ".test_name" metadata.yaml)
  echo "Loading config for test: $TEST_ID - $TEST_NAME"
else
  echo "Error: metadata.yaml not found. This script must be run from within a test directory."
  exit 1
fi

# Function to prompt user for configuration options
prompt_config() {
  # Load configuration options from config_map.yaml
  local resolutions=($(yq e ".Resolutions | keys | .[]" "$CONFIG_FILE"))
  local initial_conditions=($(yq e ".InitialConditions | keys | .[]" "$CONFIG_FILE"))
  local diffusion_settings=($(yq e ".Diffusion | keys | .[]" "$CONFIG_FILE"))

  # Prompt for resolution
  echo "Available Resolutions:"
  select resolution in "${resolutions[@]}"; do
    if [[ -n "$resolution" ]]; then
      echo "You selected resolution: $resolution"
      break
    else
      echo "Invalid selection. Please choose a resolution from the list."
    fi
  done

  # Prompt for biology or physics
  echo "Choose between Biology or Physics:"
  select bio_physics in "Biology" "Physics"; do
    if [[ -n "$bio_physics" ]]; then
      echo "You selected: $bio_physics"
      break
    else
      echo "Invalid selection. Please choose Biology or Physics."
    fi
  done

  # Prompt for initial condition configuration
  echo "Available Initial Condition Configurations:"
  select initial_condition in "${initial_conditions[@]}"; do
    if [[ -n "$initial_condition" ]]; then
      echo "You selected initial condition: $initial_condition"
      break
    else
      echo "Invalid selection. Please choose an initial condition from the list."
    fi
  done

  # Prompt for diffusion settings
  echo "Available Diffusion Settings:"
  select diffusion in "${diffusion_settings[@]}"; do
    if [[ -n "$diffusion" ]]; then
      echo "You selected diffusion setting: $diffusion"
      break
    else
      echo "Invalid selection. Please choose a diffusion setting from the list."
    fi
  done

  # Store the selected options (you can modify this to return the values)
  SELECTED_RESOLUTION="$resolution"
  SELECTED_BIO_PHYSICS="$bio_physics"
  SELECTED_INITIAL_CONDITION="$initial_condition"
  SELECTED_DIFFUSION="$diffusion"

  echo "Selected Configuration:"
  echo "  Resolution: $SELECTED_RESOLUTION"
  echo "  Biology/Physics: $SELECTED_BIO_PHYSICS"
  echo "  Initial Condition: $SELECTED_INITIAL_CONDITION"
  echo "  Diffusion: $SELECTED_DIFFUSION"

  # Confirm configuration with user
  while true; do
    read -r -p "Is this configuration correct? (y/n): " confirm
    case "$confirm" in
      [yY][eE][sS]|[yY])
        echo "Configuration confirmed."
        break
        ;;
      [nN][oO]|[nN])
        echo "Please run the script again to select a different configuration."
        exit 1
        ;;
      *)
        echo "Invalid input. Please answer 'y' or 'n'."
        ;;
    esac
  done
}

# Function to determine file paths based on selected configuration
get_file_paths() {
  local resolution="$1"
  local bio_physics="$2"
  local initial_condition="$3"
  local diffusion="$4"

  # Load file destinations from config_map.yaml into an associative array
  declare -A file_dests
  while IFS=':' read -r key value; do
    file_dests["${key}"]="${value}"
  done < <(yq e ".FileDestinations | to_entries | .[] | .key + \":\" + .value" "$CONFIG_FILE")

  # Determine source paths based on configuration
  local grid_src=$(yq e ".Resolutions.\"$resolution\".input_grd" "$CONFIG_FILE" 2>/dev/null)
  local forcing_src=$(yq e ".Resolutions.\"$resolution\".input_frc" "$CONFIG_FILE" 2>/dev/null)
  local param_src=$(yq e ".Resolutions.\"$resolution\".param" "$CONFIG_FILE" 2>/dev/null)
  local cppdefs_src=$(yq e ".BiologyPhysics.\"$bio_physics\".cppdefs" "$CONFIG_FILE" 2>/dev/null)
  local restart_src=$(yq e ".InitialConditions.\"$initial_condition\".input_rst_$resolution" "$CONFIG_FILE" 2>/dev/null) #Resolution specific restart
  local description_src=$(yq e ".InitialConditions.\"$initial_condition\".Description" "$CONFIG_FILE" 2>/dev/null)
  local diffusion_src=$(yq e ".Diffusion.\"$diffusion\".t3dmix_S" "$CONFIG_FILE" 2>/dev/null)
  local infile_src=$(yq e ".BaseFiles.infile" "$CONFIG_FILE" 2>/dev/null)
  local jobcomp_src=$(yq e ".BaseFiles.jobcomp" "$CONFIG_FILE" 2>/dev/null)
  local manifest_src=$(yq e ".BaseFiles.manifest" "$CONFIG_FILE" 2>/dev/null)

  # Print the selected file paths
  echo "Selected Files:"
  if [[ -n "$grid_src" ]]; then
    echo "  Grid: $SCRIPT_DIR/$grid_src -> $TEST_DIR/${file_dests["Grid"]}"
  else
    echo "  Grid: Not defined for this configuration"
  fi
  if [[ -n "$forcing_src" ]]; then
    echo "  Forcing: $SCRIPT_DIR/$forcing_src -> $TEST_DIR/${file_dests["Forcing"]}"
  else
    echo "  Forcing: Not defined for this configuration"
  fi
  if [[ -n "$restart_src" ]]; then
    echo "  Restart: $SCRIPT_DIR/$restart_src -> $TEST_DIR/${file_dests["Restart"]}"
  else
    echo "  Restart: Not defined for this configuration"
  fi
  if [[ -n "$param_src" ]]; then
    echo "  Param: $SCRIPT_DIR/$param_src -> $TEST_DIR/${file_dests["Param"]}"
  else
    echo "  Param: Not defined for this configuration"
  fi
   if [[ -n "$cppdefs_src" ]]; then
    echo "  Cppdefs: $SCRIPT_DIR/$cppdefs_src -> $TEST_DIR/${file_dests["Cppdefs"]}"
  else
    echo "  Cppdefs: Not defined for this configuration"
  fi
   if [[ -n "$description_src" ]]; then
    echo "  Description: $SCRIPT_DIR/$description_src -> $TEST_DIR/${file_dests["ConfigDescription"]}"
  else
    echo "  Description: Not defined for this configuration"
  fi
   if [[ -n "$diffusion_src" ]]; then
    echo "  Diffusion: $SCRIPT_DIR/$diffusion_src -> $TEST_DIR/${file_dests["Diffusion"]}"
  else
    echo "  Diffusion: Not defined for this configuration"
  fi
   if [[ -n "$infile_src" ]]; then
    echo "  Infile: $SCRIPT_DIR/$infile_src -> $TEST_DIR/${file_dests["Infile"]}"
  else
    echo "  Infile: Not defined for this configuration"
  fi
   if [[ -n "$jobcomp_src" ]]; then
    echo "  Jobcomp: $SCRIPT_DIR/$jobcomp_src -> $TEST_DIR/${file_dests["CompilationScript"]}"
  else
    echo "  Jobcomp: Not defined for this configuration"
  fi
   if [[ -n "$manifest_src" ]]; then
    echo "  Manifest: $SCRIPT_DIR/$manifest_src -> $TEST_DIR/${file_dests["Manifest"]}"
  else
    echo "  Manifest: Not defined for this configuration"
  fi
}

prompt_config

# After the configuration is confirmed, determine and print the file paths
get_file_paths "$SELECTED_RESOLUTION" "$SELECTED_BIO_PHYSICS" "$SELECTED_INITIAL_CONDITION" "$SELECTED_DIFFUSION"
