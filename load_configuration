#!/bin/bash

# Function to get the project root directory
get_project_root() {
    local dir=$(pwd)
    while [[ ! -f "$dir/settings.yaml" && "$dir" != "/" ]]; do
        dir=$(dirname "$dir")
    done
    echo "$dir"
}

# Function to display an error message and exit
error_exit() {
    echo "Error: $1" >&2
    exit 1
}

# Function to copy files based on config_map.yaml
copy_files_from_config() {
    local config_map_file="$1"
    local test_root_dir="." # Current test directory as destination root
    local project_root=$(get_project_root)

    if [[ ! -f "$config_map_file" ]]; then
        error_exit "Config map file not found: $config_map_file"
    fi

    while IFS= read -r line; do
        local src=$(echo "$line" | yq e '.src' - | tr -d '"')
        local dest=$(echo "$line" | yq e '.dest' - | tr -d '"')
        local type=$(echo "$line" | yq e '.type' - | tr -d '"')

        # Prepend project root to source path
        src="$project_root/$src"

        # Create destination directory if it doesn't exist
        if [[ ! -d "$(dirname "$dest")" ]]; then
            mkdir -p "$(dirname "$dest")"
        fi

        if [[ "$type" == "file" ]]; then
            if [[ -f "$src" ]]; then
                echo "Copying file: $src to $dest"
                cp -v "$src" "$dest"
            else
                echo "Warning: Source file not found: $src"
            fi
        elif [[ "$type" == "symlink" ]]; then
            if [[ -f "$src" ]]; then
                echo "Creating symlink: $dest -> $src"
                ln -s "$src" "$dest"
            else
                echo "Warning: Source file not found: $src"
            fi
        else
            echo "Warning: Unknown type: $type"
        fi
    done < <(yq e '.files[]' "$config_map_file" -o json | jq -c .)
}

# Check if we're in a test directory
if [[ ! -f "metadata.yaml" ]]; then
    error_exit "This script must be run from a test directory containing metadata.yaml"
fi

# Get project root
PROJECT_ROOT=$(get_project_root)

# Define the config map file path
CONFIG_MAP_FILE="$PROJECT_ROOT/Configs/config_map.yaml"

# Copy files based on the config map
copy_files_from_config "$CONFIG_MAP_FILE"

echo "Configuration loaded successfully."
